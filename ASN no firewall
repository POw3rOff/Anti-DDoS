#!/bin/bash

############ EXTRA STUFF TO HELP HIGH TRAFFIC (DDOS) ##################


###################################################################################################################
# _|___|___|___|___|___|___|___|___|___|___|___|___|                                                             ##
# ___|___|___|___|___|___|___|___|___|___|___|___|__        IPTables: Linux's Main line of Defense               ##
# _|___|___|___|___|___|___|___|___|___|___|___|___|        IPTables: Linux's way of saying no to DoS kids       ##
# ___|___|___|___|___|___|___|___|___|___|___|___|__                                                             ##    
# _|___|___|___|___|___|___|___|___|___|___|___|___|        Version 1.0.0 -                                      ##
# ___|___|___|___|___|___|___|___|___|___|___|___|__        IPTables Script created by p0w3r0ff                  ##
# _|___|___|___|___|___|___|___|___|___|___|___|___|                                                             ##
# ___|___|___|___|___|___|___|___|___|___|___|___|__        Sources used and Studied;                            ##
# _|___|___|___|___|___|___|___|___|___|___|___|___|                                                             ##
# ___|___|___|___|___|___|___|___|___|___|___|___|__     http://ipset.netfilter.org/iptables.man.html            ##
# _|___|___|___|___|___|___|___|___|___|___|___|___|                                                             ##
# ___|___|___|___|___|___|___|___|___|___|___|___|__                                                             ##
###################################################################################################################

#----------------------------------------------------------#
# Config                                                   #
#----------------------------------------------------------#

# URL da lista de ASNs para bloqueio (substitua por URLs válidas)
# Exemplo: ASN_LIST_URLS=("https://example.com/asns1.txt")
ASN_LIST_URLS=()

# Diretório de destino para salvar a lista de IPs
LIST_DIR="/etc/iptables/"
# Data de validade da lista de ASNs (exemplo de data futura)
ASN_LIST_EXPIRY="2025-01-01"

# Serviços de bad ASN para usar
# Estes são placeholders; você precisa de uma fonte real que forneça prefixos por ASN ou nome
# BAD_ASN_SERVICES=("spamhaus" "openphish" "malwarepatrol")
BAD_ASN_SERVICES=()

#----------------------------------------------------------#
# Functions                                                #
#----------------------------------------------------------#

# Função para processar a lista de ASNs e adicionar regras de bloqueio
processarASN() {
    local ASN_LIST="$1"
    local ACTION="$2"

    if [ ! -f "$ASN_LIST" ]; then
        echo "Arquivo de ASN não encontrado: $ASN_LIST"
        return
    fi

    # Adiciona regras de bloqueio
    # OTIMIZAÇÃO: Usando iptables-restore para carregar regras em lote.
    local RESTORE_FILE="${ASN_LIST}.restore"
    echo "*filter" > "$RESTORE_FILE"

    # Assume que o arquivo contém CIDRs ou IPs, não strings para '-m string'
    # Se a lista for de prefixos IP (CIDR):
    grep -v '^$' "$ASN_LIST" | grep -v '#' | \
    sed "s|^|-A BLOCK_ASN -s |; s|$| -j $ACTION|" >> "$RESTORE_FILE"

    echo "COMMIT" >> "$RESTORE_FILE"

    sudo iptables-restore --noflush < "$RESTORE_FILE"
    rm -f "$RESTORE_FILE"
}

# Função para baixar a lista de ASNs
baixarASN() {
    local ASN_URL="$1"
    local ASN_LIST="$2"

    sudo wget -q -O "$ASN_LIST" "$ASN_URL"
}

#----------------------------------------------------------#
# ASN Block Rules                                           #
#----------------------------------------------------------#

# Verificar/Criar diretório
if [ ! -d "$LIST_DIR" ]; then
    sudo mkdir -p "$LIST_DIR"
fi

# Criando a chain BLOCK_ASN se não existir
sudo iptables -N BLOCK_ASN 2>/dev/null
# Limpar chain
sudo iptables -F BLOCK_ASN

# Processando cada URL da lista de ASN
for ASN_URL in "${ASN_LIST_URLS[@]}"; do
    ASN_LIST="${LIST_DIR}$(basename "$ASN_URL")"

    # Baixando a lista de ASN
    baixarASN "$ASN_URL" "$ASN_LIST"

    # Adicionando regras de bloqueio
    processarASN "$ASN_LIST" "DROP"
done

# Adicionando regras de bloqueio para serviços de bad ASN
for BAD_ASN_SERVICE in "${BAD_ASN_SERVICES[@]}"; do
    # URL de exemplo - precisa ser substituída por uma URL real que retorne prefixos IP
    ASN_LIST_URL="https://example.com/data/prefixes/${BAD_ASN_SERVICE}.txt"
    ASN_LIST="${LIST_DIR}${BAD_ASN_SERVICE}.txt"

    # Baixando a lista de ASN
    baixarASN "$ASN_LIST_URL" "$ASN_LIST"

    # Adicionando regras de bloqueio
    processarASN "$ASN_LIST" "DROP"
done

# Adicionando a chain BLOCK_ASN às regras existentes se não existir
if ! sudo iptables -C INPUT -j BLOCK_ASN 2>/dev/null; then
    sudo iptables -A INPUT -j BLOCK_ASN
    sudo iptables -A OUTPUT -j BLOCK_ASN
    sudo iptables -A FORWARD -j BLOCK_ASN
fi

# Mensagem de conclusão do script
echo "Regras de ASN configuradas com sucesso!"
