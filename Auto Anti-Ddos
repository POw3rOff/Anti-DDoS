#!/bin/bash

############ EXTRA STUFF TO HELP HIGH TRAFFIC (DDOS) ##################

###################################################################################################################

# Função para mensagens de log
msg() {
    echo "[$(date +'%Y-%m-%d %H:%M:%S')] $1"
}

log() {
    msg "$1"
}

#----------------------------------------------------------#
# Proteção contra DDoS no nível do Kernel                  #
#----------------------------------------------------------#

msg "Configurando proteção contra DDoS no nível do Kernel..."

# Habilita proteção contra SYN-flood
sysctl -w net.ipv4.tcp_syncookies=1 >/dev/null
sysctl -w net.ipv4.tcp_max_syn_backlog=2048 >/dev/null
sysctl -w net.ipv4.tcp_synack_retries=2 >/dev/null
sysctl -w net.ipv4.tcp_syn_retries=5 >/dev/null

# Habilita proteção contra ICMP-flood
sysctl -w net.ipv4.icmp_echo_ignore_broadcasts=1 >/dev/null
sysctl -w net.ipv4.icmp_ignore_bogus_error_responses=1 >/dev/null

# Limita o número de conexões por IP
sysctl -w net.ipv4.tcp_max_orphans=1024 >/dev/null
sysctl -w net.ipv4.tcp_max_tw_buckets=1440000 >/dev/null
sysctl -w net.ipv4.tcp_orphan_retries=1 >/dev/null

# Limita o número de conexões simultâneas por IP
sysctl -w net.ipv4.ip_local_port_range="1024 65535" >/dev/null
sysctl -w net.ipv4.tcp_tw_reuse=1 >/dev/null
sysctl -w net.ipv4.tcp_tw_recycle=1 >/dev/null

# Proteção contra ataques amplification/reflection
sysctl -w net.ipv4.icmp_echo_ignore_all=1 >/dev/null
sysctl -w net.ipv4.icmp_ignore_bogus_error_messages=1 >/dev/null

msg "Proteção contra DDoS no nível do Kernel configurada com sucesso!"

#----------------------------------------------------------#
# Configuração de Blocklists                               #
#----------------------------------------------------------#

# Lista de serviços de blocklist para usar
BLOCKLIST_SERVICES=(
  "https://lists.blocklist.de/lists/all.txt"
  "https://zeustracker.abuse.ch/blocklist.php?download=badips"
  "https://www.binarydefense.com/banlist.txt"
  "https://feodotracker.abuse.ch/blocklist/?download=ipblocklist"
  "https://www.spamhaus.org/drop/drop.txt"
  "https://www.spamhaus.org/drop/edrop.txt"
  "https://check.torproject.org/exit-addresses"
  "https://ransomwaretracker.abuse.ch/downloads/RW_IPBL.txt"
  "https://www.autoshun.org/files/shunlist.csv"
  "https://blocklist.cyberthreatcoalition.org/vetted/domain.txt"
  "https://blocklist.cyberthreatcoalition.org/vetted/ip.txt"
  "https://www.dshield.org/feeds/suspiciousdomains_High.txt"
  "https://rules.emergingthreats.net/fwrules/emerging-Block-IPs.txt"
  "https://reputation.alienvault.com/reputation.generic"
  "https://www.blocklist.de/downloads/export-ips_all.txt"
  "https://sslbl.abuse.ch/blacklist/sslipblacklist.csv"
  "https://raw.githubusercontent.com/stamparm/ipsum/master/ipsum.txt"
  "https://gitlab.com/quidsup/notrack-blocklists/raw/master/notrack-blocklist.txt"
  "https://lists.blocklist.de/lists/bots.txt"
  "https://www.openbl.org/lists/base.txt"
  "https://raw.githubusercontent.com/firehol/blocklist-ipsets/master/stopforumspam_1d.ipset"
  "https://raw.githubusercontent.com/firehol/blocklist-ipsets/master/stopforumspam_7d.ipset"
  "https://raw.githubusercontent.com/firehol/blocklist-ipsets/master/stopforumspam_30d.ipset"
)

# Diretório de destino para salvar as listas de blocklist
BLOCKLIST_DIR="/etc/iptables/blocklists/"
if [ ! -d "$BLOCKLIST_DIR" ]; then
    mkdir -p "$BLOCKLIST_DIR"
fi

# Função para baixar e processar blocklists
processarBlocklists() {
    local BLOCKLIST_URL="$1"
    local FILENAME=$(basename "$BLOCKLIST_URL")
    local OUTPUT_FILE="$BLOCKLIST_DIR/$FILENAME"
    local TMP_FILE="$BLOCKLIST_DIR/tmp_file"

    msg "Baixando $BLOCKLIST_URL..."
    # Download a blocklist
    wget -q -O "$TMP_FILE" "$BLOCKLIST_URL"

    if [ -f "$TMP_FILE" ]; then
        # Remove IPs duplicados e valida IP simples
        grep -Eo '([0-9]{1,3}\.){3}[0-9]{1,3}' "$TMP_FILE" | sort -u > "$OUTPUT_FILE"
        rm "$TMP_FILE"
    else
        msg "Falha no download de $BLOCKLIST_URL"
    fi
}

# Processa cada serviço de blocklist
for BLOCKLIST_SERVICE in "${BLOCKLIST_SERVICES[@]}"; do
    processarBlocklists "$BLOCKLIST_SERVICE"
done

# Cria uma lista única combinando todas as blocklists
LISTA_COMBINADA="$BLOCKLIST_DIR/lista_combinada.txt"
cat "$BLOCKLIST_DIR"/*.txt 2>/dev/null | grep -Eo '([0-9]{1,3}\.){3}[0-9]{1,3}' | sort -u > "$LISTA_COMBINADA"

#----------------------------------------------------------#
# Bloqueio de IPs das Blocklists no iptables               #
#----------------------------------------------------------#

msg "Bloqueando IPs das blocklists no iptables..."

# Criando a chain BLOCK_BLOCKLIST se não existir
iptables -N BLOCK_BLOCKLIST 2>/dev/null
# Limpa regras antigas
iptables -F BLOCK_BLOCKLIST

# Adicionando regras de bloqueio para IPs nas blocklists
# Nota: Isso pode demorar muito. IPSET seria melhor.
if [ -f "$LISTA_COMBINADA" ]; then
    TOTAL_IPS=$(wc -l < "$LISTA_COMBINADA")
    msg "Total de IPs a bloquear: $TOTAL_IPS"

    while IFS= read -r IP; do
        if [[ -n "$IP" ]]; then
            iptables -A BLOCK_BLOCKLIST -s "$IP" -j DROP
        fi
    done < "$LISTA_COMBINADA"
fi

# Adicionando a chain BLOCK_BLOCKLIST às regras existentes se ainda não estiver lá
iptables -C INPUT -j BLOCK_BLOCKLIST 2>/dev/null || iptables -A INPUT -j BLOCK_BLOCKLIST
iptables -C OUTPUT -j BLOCK_BLOCKLIST 2>/dev/null || iptables -A OUTPUT -j BLOCK_BLOCKLIST
iptables -C FORWARD -j BLOCK_BLOCKLIST 2>/dev/null || iptables -A FORWARD -j BLOCK_BLOCKLIST

# Log
log "Bloqueio de IPs das blocklists no iptables configurado com sucesso!"

#----------------------------------------------------------#
#                    Mensagem final                        #
#----------------------------------------------------------#

# Tipos de ataques bloqueados
msg "Tipos de ataques bloqueados:"
msg "- Ataques SYN/ACK"
msg "- Ataques de flood ICMP (ping)"
msg "- Ataques de flood UDP"
msg "- Conexões inválidas"
msg "- Ataques de força bruta (SSH)"
msg "- Ping da morte"
msg "- Tráfego multicast e broadcast"
msg "- Tráfego de loopback falso"
msg "- Pacotes com endereços IP de origem falsificados (spoofing)"

# Mensagem final
msg "Configurações aplicadas com sucesso!"
