#!/bin/bash

############ EXTRA STUFF TO HELP HIGH TRAFFIC (DDOS) ##################

###################################################################################################################
# _|___|___|___|___|___|___|___|___|___|___|___|___|                                                             ##
# ___|___|___|___|___|___|___|___|___|___|___|___|__        IPTables: Linux's Main line of Defense               ##
# _|___|___|___|___|___|___|___|___|___|___|___|___|        IPTables: Linux's way of saying no to DoS kids       ##
# ___|___|___|___|___|___|___|___|___|___|___|___|__                                                             ##    
# _|___|___|___|___|___|___|___|___|___|___|___|___|        Version 1.0.0 -                                      ##
# ___|___|___|___|___|___|___|___|___|___|___|___|__        IPTables Script created by p0w3r0ff                  ##
# _|___|___|___|___|___|___|___|___|___|___|___|___|                                                             ##
# ___|___|___|___|___|___|___|___|___|___|___|___|__        Sources used and Studied;                            ##
# _|___|___|___|___|___|___|___|___|___|___|___|___|                                                             ##
# ___|___|___|___|___|___|___|___|___|___|___|___|__     http://ipset.netfilter.org/iptables.man.html            ##
# _|___|___|___|___|___|___|___|___|___|___|___|___|                                                             ##
# ___|___|___|___|___|___|___|___|___|___|___|___|__                                                             ##
###################################################################################################################

# Verificar se o iptables está instalado e instalá-lo se necessário
if ! command -v iptables &> /dev/null; then
    echo "Iptables não está instalado. Instalando..."
    sudo apt-get update
    sudo apt-get install -y iptables
fi

# Verificar se o ipset está instalado e instalá-lo se necessário
if ! command -v ipset &> /dev/null; then
    echo "Ipset não está instalado. Instalando..."
    sudo apt-get update
    sudo apt-get install -y ipset
fi

# Instalar e configurar Fail2Ban
echo "Instalando fail2ban..."
sudo apt-get update
sudo apt-get install -y fail2ban

# Configurar jail.local para SSH e Apache
cat <<EOL | sudo tee /etc/fail2ban/jail.local
[sshd]
enabled = true

[apache]
enabled = true

[nginx-http-auth]
enabled = true
EOL

# Reiniciar Fail2Ban
sudo service fail2ban restart

# Instalar e configurar ModSecurity
echo "Instalando ModSecurity..."
sudo apt-get update
sudo apt-get install -y libapache2-mod-security2
if [ -f /etc/modsecurity/modsecurity.conf-recommended ]; then
    sudo cp /etc/modsecurity/modsecurity.conf-recommended /etc/modsecurity/modsecurity.conf
fi

# Configurar SecRuleEngine
sudo sed -i 's/SecRuleEngine DetectionOnly/SecRuleEngine On/' /etc/modsecurity/modsecurity.conf

# Reiniciar Apache
sudo service apache2 restart

# Função para baixar e atualizar a lista de bloqueio
update_blocklist() {
    BLOCKLIST_URLS=(
        "https://lists.blocklist.de/lists/all.txt"
        "https://www.spamhaus.org/drop/drop.txt"
    )

    BLOCKLIST_FILE="/tmp/combined_blocklist.txt"

    # Limpar arquivo anterior
    > "$BLOCKLIST_FILE"

    for url in "${BLOCKLIST_URLS[@]}"; do
        echo "Baixando $url..."
        wget -q -O - "$url" | grep -Eo '([0-9]{1,3}\.){3}[0-9]{1,3}' >> "$BLOCKLIST_FILE"
    done

    # Remover IPs duplicados
    if [ -s "$BLOCKLIST_FILE" ]; then
        sort -u -o "$BLOCKLIST_FILE" "$BLOCKLIST_FILE"
    fi
}

# Verificar se a lista de bloqueio existe e tem menos de 48 horas
BLOCKLIST_FILE="/tmp/combined_blocklist.txt"
# Se não existe ou é mais velho que 2 dias (48h*60m=2880m)
if [ ! -e "$BLOCKLIST_FILE" ] || [ -n "$(find "$BLOCKLIST_FILE" -mmin +2880)" ]; then
    echo "Atualizando a lista de bloqueio..."
    update_blocklist
else
    echo "A lista de bloqueio ainda está atualizada."
fi

# Adicionar IPs ao iptables (Otimizado com ipset)
echo "Configurando ipset..."
# Criar o set se não existir
sudo ipset create blocklist hash:ip hashsize 4096 -exist

# Usar ipset restore para carregar IPs em massa
IPSET_RESTORE_FILE=$(mktemp)
echo "create blocklist hash:ip hashsize 4096 -exist" > "$IPSET_RESTORE_FILE"
if [ -f "$BLOCKLIST_FILE" ]; then
    grep -Eo '([0-9]{1,3}\.){3}[0-9]{1,3}' "$BLOCKLIST_FILE" | sed 's/^/add blocklist /' >> "$IPSET_RESTORE_FILE"
fi

# Aplicar ipset
sudo ipset restore < "$IPSET_RESTORE_FILE"
rm "$IPSET_RESTORE_FILE"

# Adicionar regra ao iptables para usar o set
# Verifica se a regra já existe para evitar duplicatas
if ! sudo iptables -C INPUT -m set --match-set blocklist src -j DROP 2>/dev/null; then
    sudo iptables -A INPUT -m set --match-set blocklist src -j DROP
fi

# Configurar limites de taxa no Nginx (substitua pela sua configuração)
if [ -d /etc/nginx/conf.d ]; then
    echo "limit_req_zone \$binary_remote_addr zone=req_limit:10m rate=5r/s;" | sudo tee /etc/nginx/conf.d/limit_req.conf
fi

# Configurar mod_evasive para proteção contra ataques de solicitações excessivas no Apache
echo "Instalando mod_evasive..."
sudo apt-get install -y libapache2-mod-evasive
cat <<EOL | sudo tee /etc/apache2/mods-available/evasive.conf
<IfModule mod_evasive20.c>
    DOSHashTableSize    3097
    DOSPageCount        2
    DOSSiteCount        50
    DOSPageInterval     1
    DOSSiteInterval     1
    DOSBlockingPeriod   10
</IfModule>
EOL
# Habilitar módulo se disponível (em alguns sistemas já vem habilitado)
if [ -f /usr/sbin/a2enmod ]; then
    sudo a2enmod evasive
fi
sudo service apache2 restart

# Configurar limites de taxa no iptables
sudo iptables -A INPUT -p tcp -m tcp --syn -m connlimit --connlimit-above 50 -j DROP
# Regras baseadas em interface (assume eth0, pode falhar se não existir)
INTERFACE=$(ip route | grep default | awk '{print $5}' | head -n1)
if [ -n "$INTERFACE" ]; then
    sudo iptables -A INPUT -p tcp -m tcp --dport 80 -i "$INTERFACE" -m state --state NEW -m recent --set
    sudo iptables -A INPUT -p tcp -m tcp --dport 80 -i "$INTERFACE" -m state --state NEW -m recent --update --seconds 60 --hitcount 20 -j DROP
fi

echo "Script concluído!"
