#!/bin/bash

############ EXTRA STUFF TO HELP HIGH TRAFFIC (DDOS) ##################

###################################################################################################################
# _|___|___|___|___|___|___|___|___|___|___|___|___|                                                             ##
# ___|___|___|___|___|___|___|___|___|___|___|___|__        IPTables: Linux's Main line of Defense               ##
# _|___|___|___|___|___|___|___|___|___|___|___|___|        IPTables: Linux's way of saying no to DoS kids       ##
# ___|___|___|___|___|___|___|___|___|___|___|___|__                                                             ##    
# _|___|___|___|___|___|___|___|___|___|___|___|___|        Version 1.0.0 -                                      ##
# ___|___|___|___|___|___|___|___|___|___|___|___|__        IPTables Script created by p0w3r0ff                  ##
# _|___|___|___|___|___|___|___|___|___|___|___|___|                                                             ##
# ___|___|___|___|___|___|___|___|___|___|___|___|__        Sources used and Studied;                            ##
# _|___|___|___|___|___|___|___|___|___|___|___|___|                                                             ##
# ___|___|___|___|___|___|___|___|___|___|___|___|__     http://ipset.netfilter.org/iptables.man.html            ##
# _|___|___|___|___|___|___|___|___|___|___|___|___|                                                             ##
# ___|___|___|___|___|___|___|___|___|___|___|___|__                                                             ##
###################################################################################################################

# URL das listas (substitua pelos URLs reais)
LIST_URLS=(
    "https://www.spamhaus.org/drop/drop.txt"
    "https://feeds.dshield.org/top10-2.txt"
    "https://lists.blocklist.de/lists/all.txt"
)

# Nome do arquivo de saída
OUTPUT_FILE="/tmp/combined_blocklist.txt"

# Limpar regras existentes
sudo iptables -F
sudo iptables -X

# Definir política padrão para DROP (bloquear tudo por padrão)
sudo iptables -P INPUT DROP
sudo iptables -P FORWARD DROP
sudo iptables -P OUTPUT ACCEPT

# Permitir tráfego na interface de loopback
sudo iptables -A INPUT -i lo -j ACCEPT
sudo iptables -A OUTPUT -o lo -j ACCEPT

# Permitir tráfego SSH (substitua PORTA_SSH pelo número da porta desejado, ex: 22)
sudo iptables -A INPUT -p tcp --dport 22 -j ACCEPT

# Permitir tráfego HTTP e HTTPS
sudo iptables -A INPUT -p tcp --dport 80 -j ACCEPT
sudo iptables -A INPUT -p tcp --dport 443 -j ACCEPT

# Função para baixar e combinar as listas
update_lists() {
    > "$OUTPUT_FILE"
    for url in "${LIST_URLS[@]}"; do
        wget -q -O - "$url" | grep -Eo '([0-9]{1,3}\.){3}[0-9]{1,3}' >> "$OUTPUT_FILE"
    done
    if [ -s "$OUTPUT_FILE" ]; then
        sort -u -o "$OUTPUT_FILE" "$OUTPUT_FILE"
    fi
}

# Atualizar as listas apenas se o arquivo não existir ou tiver mais de 48 horas
if [ ! -e "$OUTPUT_FILE" ] || [ "$(find "$OUTPUT_FILE" -mmin +2880)" ]; then
    update_lists
fi

# Adicionar IPs ao iptables
if [ -f "$OUTPUT_FILE" ]; then
    # Usar ipset para melhor performance se disponível
    if command -v ipset &>/dev/null; then
        sudo ipset create blocklist hash:ip hashsize 4096 -exist
        while IFS= read -r ip; do
            sudo ipset add blocklist "$ip" -exist
        done < "$OUTPUT_FILE"
        sudo iptables -A INPUT -m set --match-set blocklist src -j DROP
    else
        while IFS= read -r ip; do
            sudo iptables -A INPUT -s "$ip" -j DROP
        done < "$OUTPUT_FILE"
    fi
fi

# Configurar ModSecurity (se instalado)
if [ -d /etc/apache2 ]; then
    # Habilitar ModSecurity se o arquivo de configuração existir
    if [ ! -f /etc/apache2/mods-enabled/security2.conf ] && [ -f /etc/apache2/mods-available/security2.conf ]; then
        sudo a2enmod security2
    fi
    sudo service apache2 restart
fi

echo "Script concluído!"
