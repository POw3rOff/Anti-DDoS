#!/usr/sbin/nft -f

flush ruleset

# --- Definições ---
define WAN_IF = eth0
define SSH_PORT = 22
define WEB_PORTS = { 80, 443 }

table inet filter {
    # --- Sets (Listas de IPs) ---
    set BLACKLIST {
        type ipv4_addr
        flags interval
        # Adicione IPs aqui: elements = { 192.0.2.1, 198.51.100.0/24 }
    }

    # --- Cadeia de Entrada (Input) ---
    chain input {
        type filter hook input priority 0; policy drop;

        # 1. Aceitar tráfego de Loopback
        iif "lo" accept

        # 2. Bloquear IPs na Blacklist imediatamente
        ip saddr @BLACKLIST drop

        # 3. Regras Básicas: Estabelecidas e Relacionadas
        ct state established,related accept

        # 4. Bloquear tráfego inválido
        ct state invalid drop

        # 5. ICMP (Ping) com limite de taxa (Advanced)
        ip protocol icmp icmp type echo-request limit rate 1/second accept

        # 6. SSH com proteção contra força bruta (Advanced)
        # Permite SSH mas limita novas conexões a 3 por minuto
        tcp dport $SSH_PORT ct state new limit rate 3/minute burst 5 packets accept

        # 7. Web Server (HTTP/HTTPS) - Permitir padrão
        tcp dport $WEB_PORTS ct state new accept

        # 8. Proteção contra TCP Bogus flags (Advanced)
        tcp flags & (fin|syn|rst|ack) == 0 drop # NULL packets
        tcp flags & (fin|syn|rst|psh|ack|urg) == (fin|syn|rst|psh|ack|urg) drop # XMAS packets
        tcp flags & (syn|rst) == (syn|rst) drop # SYN+RST

        # Logar pacotes rejeitados (opcional, cuidado com disco cheio)
        # limit rate 5/minute log prefix "NFT-DROP: "
    }

    # --- Cadeia de Encaminhamento (Forward) ---
    chain forward {
        type filter hook forward priority 0; policy drop;
        # Se for um roteador/gateway, adicione regras aqui.
    }

    # --- Cadeia de Saída (Output) ---
    chain output {
        type filter hook output priority 0; policy accept;
    }
}

# --- Tabela para IPV6 (Bloquear se não usar) ---
# table ip6 filter {
#     chain input {
#         type filter hook input priority 0; policy drop;
#     }
#     chain forward {
#         type filter hook forward priority 0; policy drop;
#     }
#     chain output {
#         type filter hook output priority 0; policy drop;
#     }
# }
