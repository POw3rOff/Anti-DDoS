#!/bin/bash

# Script: detecao_exploits_locais.sh
# Descrição: Procura por artefatos de exploits conhecidos e configurações de risco.
# Autor: Jules (Agente de IA)

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

echo -e "${YELLOW}=== Detecção de Artefatos de Exploit e Riscos Locais ===${NC}"

# 1. Arquivos com nomes suspeitos (Padrões comuns de exploits públicos)
echo -e "${YELLOW}[*] Buscando arquivos com nomes suspeitos (ex: exploit.c, dirtycow)...${NC}"
SUSPICIOUS_NAMES="dirtycow|pwnkit|cve-20|exploit.c|shell.c|linpeas|pspy"
# Busca em /tmp, /var/tmp, /dev/shm, /home (limitado para não demorar horas)
SEARCH_DIRS="/tmp /var/tmp /dev/shm /home"

for dir in $SEARCH_DIRS; do
    if [ -d "$dir" ]; then
        FOUND=$(find "$dir" -maxdepth 4 -type f -name "*.*" 2>/dev/null | grep -E -i "$SUSPICIOUS_NAMES")
        if [ -n "$FOUND" ]; then
             echo -e "${RED}[!] Arquivos suspeitos encontrados em $dir:${NC}"
             echo "$FOUND"
        fi
    fi
done

# 2. Binários SUID desconhecidos/estranhos
echo -e "${YELLOW}[*] Buscando binários SUID (SetUID) em locais incomuns...${NC}"
# Exclui diretórios padrão de binários para focar em locais anômalos (/tmp, /home, /var)
SUID_FILES=$(find / -type f -perm -4000 -not -path "/bin/*" -not -path "/usr/bin/*" -not -path "/sbin/*" -not -path "/usr/sbin/*" -not -path "/usr/lib/*" -not -path "/usr/libexec/*" 2>/dev/null)

if [ -n "$SUID_FILES" ]; then
    echo -e "${RED}[!] Binários SUID encontrados fora dos diretórios padrão:${NC}"
    echo "$SUID_FILES"
    echo -e "${YELLOW}    Verifique se são legítimos. SUID em /tmp ou /home é altamente suspeito.${NC}"
else
    echo -e "${GREEN}[OK] Nenhum binário SUID anômalo detectado fora dos caminhos padrão.${NC}"
fi

# 3. Scripts com permissão de escrita global (World Writable)
echo -e "${YELLOW}[*] Buscando scripts executáveis com permissão de escrita para todos...${NC}"
WW_SCRIPTS=$(find /etc /usr/local/bin -type f \( -name "*.sh" -o -name "*.py" -o -name "*.pl" \) -perm -o+w 2>/dev/null)

if [ -n "$WW_SCRIPTS" ]; then
    echo -e "${RED}[!] Scripts executáveis alteráveis por qualquer usuário encontrados:${NC}"
    echo "$WW_SCRIPTS"
else
    echo -e "${GREEN}[OK] Nenhum script crítico com permissão de escrita global encontrado em /etc ou /usr/local/bin.${NC}"
fi

echo -e "${YELLOW}=== Verificação Concluída ===${NC}"
